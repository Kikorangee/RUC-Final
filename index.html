<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Geotab API Runner</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      margin: 10px; 
      background: #f8f9fa;
    }
    input, button, select, textarea { 
      margin: 4px 0; 
      padding: 8px; 
      width: 100%; 
      box-sizing: border-box; 
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .error { color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px; margin: 8px 0; border: 1px solid #f5c6cb; }
    .success { color: #155724; background: #d4edda; padding: 10px; border-radius: 4px; margin: 8px 0; border: 1px solid #c3e6cb; }
    .warning { background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 8px 0; border: 1px solid #ffeaa7; }
    .result { 
      white-space: pre-wrap; 
      background: #f8f9fa; 
      padding: 12px; 
      margin: 8px 0; 
      border-radius: 4px; 
      max-height: 300px; 
      overflow-y: auto; 
      border: 1px solid #e9ecef;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    button { 
      cursor: pointer; 
      margin: 2px; 
      background: #007bff;
      color: white;
      border: none;
    }
    button:hover { background: #0056b3; }
    .section { 
      border: 1px solid #dee2e6; 
      padding: 15px; 
      margin: 10px 0; 
      border-radius: 8px; 
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    h3 { margin-top: 0; color: #495057; }
    .example-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
      gap: 8px; 
      margin: 10px 0; 
    }
    .example-btn { 
      padding: 6px 10px; 
      background: #28a745; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 12px;
    }
    .example-btn:hover { background: #1e7e34; }
    .category { 
      background: #f8f9fa; 
      padding: 10px; 
      margin: 5px 0; 
      border-radius: 4px; 
      border: 1px solid #e9ecef;
    }
    .category h4 { margin: 0 0 10px 0; color: #6c757d; }
    .geotab-header {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      padding: 15px;
      margin: -10px -10px 20px -10px;
      border-radius: 8px 8px 0 0;
    }
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-connected { background: #28a745; }
    .status-disconnected { background: #dc3545; }
  </style>
</head>
<body>
  <div class="geotab-header">
    <h2>üöÄ Geotab API Runner</h2>
    <p>Complete toolkit for fleet management API testing</p>
  </div>
  
  <div class="success">
    <strong>‚úÖ Geotab Add-in Active</strong><br>
    This tool is now integrated with your Geotab environment
  </div>

  <div class="section">
    <h3>üîê Authentication</h3>
    <div class="warning">
      <strong>üîí Security Note:</strong> Credentials are not stored and remain within your browser session only.
    </div>
    <input id="server" placeholder="Server (e.g., my.geotab.com)" value="">
    <input id="database" placeholder="Database" value="">
    <input id="username" placeholder="Username" value="">
    <input id="password" placeholder="Password" type="password" value="">
    <button id="authButton">
      <span class="status-indicator status-disconnected"></span>
      Authenticate
    </button>
    <div id="authResult"></div>
  </div>

  <div id="apiSection" style="display:none;" class="section">
    <h3>üîß API Testing</h3>
    <div class="success">
      <span class="status-indicator status-connected"></span>
      ‚úÖ Connected to Geotab
    </div>
    <p><strong>Server:</strong> <span id="connectedServer"></span></p>
    <p><strong>Database:</strong> <span id="connectedDB"></span></p>
    <p><strong>User:</strong> <span id="connectedUser"></span></p>
    
    <select id="method">
      <option value="Get">Get</option>
      <option value="Add">Add</option>
      <option value="Set">Set</option>
      <option value="Remove">Remove</option>
      <option value="ExecuteMultiCall">ExecuteMultiCall</option>
    </select>
    
    <input id="typeName" placeholder="typeName" value="Device">
    
    <textarea id="params" placeholder='Parameters (JSON)' rows="4">{"resultsLimit": 10}</textarea>
    
    <div style="display: flex; gap: 5px;">
      <button id="runApi" style="background: #28a745; flex: 1;">üöÄ Run API Call</button>
      <button id="downloadCsv" style="background: #17a2b8; flex: 1;">üìä Download CSV</button>
      <button id="logout" style="background: #dc3545; flex: 1;">üîê Logout</button>
    </div>
    
    <div id="apiResult"></div>
  </div>

  <div class="section">
    <h3>üìã Quick API Examples</h3>
    
    <div class="category">
      <h4>üöó Vehicle & Device Data</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('devices')">All Devices</button>
        <button class="example-btn" onclick="loadExample('device-status')">Device Status</button>
        <button class="example-btn" onclick="loadExample('device-odometer')">Odometer Data</button>
        <button class="example-btn" onclick="loadExample('devices-in-group')">Group Devices</button>
      </div>
    </div>

    <div class="category">
      <h4>üìç Location & Trip Data</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('gps-data')">GPS Data</button>
        <button class="example-btn" onclick="loadExample('trips')">Recent Trips</button>
        <button class="example-btn" onclick="loadExample('stops')">Stops</button>
        <button class="example-btn" onclick="loadExample('zones')">All Zones</button>
      </div>
    </div>

    <div class="category">
      <h4>‚õΩ Engine & Diagnostics</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('fuel-data')">Fuel Data</button>
        <button class="example-btn" onclick="loadExample('engine-data')">Engine Status</button>
        <button class="example-btn" onclick="loadExample('fault-data')">Fault Data</button>
        <button class="example-btn" onclick="loadExample('diagnostics')">Diagnostics</button>
      </div>
    </div>

    <div class="category">
      <h4>üîß Advanced Operations</h4>
      <div class="example-grid">
        <button class="example-btn" onclick="loadExample('multi-odometer')">Multi-Odometer</button>
        <button class="example-btn" onclick="loadExample('fleet-summary')">Fleet Summary</button>
        <button class="example-btn" onclick="loadExample('users')">All Users</button>
        <button class="example-btn" onclick="loadExample('groups')">All Groups</button>
      </div>
    </div>
  </div>

  <script>
    let credentials = null;
    let serverUsed = null;
    let lastApiResult = null;

    // Initialize Geotab add-in integration
    function initializeGeotabAddin() {
      // Check if running within Geotab
      if (window.parent && window.parent !== window) {
        console.log('Running as Geotab Add-in');
        // Could add Geotab-specific initialization here
      }
    }

    function showMessage(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.innerHTML = `<div class="${type}">${message}</div>`;
    }

    // Direct API call function
    async function callGeotabAPI(method, params = {}) {
      const requestBody = {
        method: method,
        params: credentials ? { ...params, credentials: credentials } : params
      };

      const response = await fetch(`https://${serverUsed}/apiv1`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      
      if (data.error) {
        throw new Error(data.error.message || data.error.name);
      }
      
      return data.result;
    }

    // Authentication
    document.getElementById('authButton').onclick = async function() {
      const server = document.getElementById('server').value.trim();
      const database = document.getElementById('database').value.trim();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      
      document.getElementById('authResult').innerHTML = '';
      
      if (!server || !database || !username || !password) {
        showMessage('authResult', '‚ùå Please fill in all fields', 'error');
        return;
      }
      
      try {
        showMessage('authResult', 'üîç Authenticating...', 'warning');
        
        serverUsed = server;
        const result = await callGeotabAPI('Authenticate', {
          userName: username,
          password: password,
          database: database
        });
        
        // Handle server redirect
        if (result.path && result.path !== 'ThisServer') {
          serverUsed = result.path;
          showMessage('authResult', `üîÑ Redirecting to ${result.path}...`, 'warning');
          
          const redirectResult = await callGeotabAPI('Authenticate', {
            userName: username,
            password: password,
            database: database
          });
          
          credentials = redirectResult.credentials;
        } else {
          credentials = result.credentials;
        }
        
        showMessage('authResult', '‚úÖ Authentication successful!', 'success');
        
        // Update UI
        document.getElementById('connectedServer').textContent = serverUsed;
        document.getElementById('connectedDB').textContent = database;
        document.getElementById('connectedUser').textContent = username;
        document.getElementById('apiSection').style.display = '';
        
        // Update button status
        const authBtn = document.getElementById('authButton');
        authBtn.innerHTML = '<span class="status-indicator status-connected"></span>Connected';
        
      } catch (error) {
        showMessage('authResult', `‚ùå Authentication failed: ${error.message}`, 'error');
      }
    };

    // API call execution
    document.getElementById('runApi').onclick = async function() {
      if (!credentials) {
        showMessage('apiResult', '‚ùå Not authenticated', 'error');
        return;
      }

      const method = document.getElementById('method').value;
      const typeName = document.getElementById('typeName').value.trim();
      let params = {};
      
      const paramsText = document.getElementById('params').value.trim();
      if (paramsText) {
        try {
          params = JSON.parse(paramsText);
        } catch (e) {
          showMessage('apiResult', `‚ùå Invalid JSON: ${e.message}`, 'error');
          return;
        }
      }
      
      if (typeName && method !== 'ExecuteMultiCall') {
        params.typeName = typeName;
      }
      
      try {
        showMessage('apiResult', 'üîç Making API call...', 'warning');
        
        const result = await callGeotabAPI(method, params);
        
        const resultCount = Array.isArray(result) ? result.length : (result ? 1 : 0);
        showMessage('apiResult', `‚úÖ Success! Found ${resultCount} result(s)`, 'success');
        document.getElementById('apiResult').innerHTML += `<div class="result">${JSON.stringify(result, null, 2)}</div>`;
        
        lastApiResult = {
          method: method,
          typeName: typeName,
          data: result,
          timestamp: new Date().toISOString()
        };
        
      } catch (error) {
        showMessage('apiResult', `‚ùå API call failed: ${error.message}`, 'error');
      }
    };

    // Load API examples
    function loadExample(type) {
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 24*60*60*1000).toISOString().split('T')[0];
      
      const examples = {
        'devices': {
          method: 'Get',
          typeName: 'Device',
          params: '{"resultsLimit": 20}'
        },
        'device-status': {
          method: 'Get',
          typeName: 'DeviceStatusInfo',
          params: '{"resultsLimit": 10}'
        },
        'device-odometer': {
          method: 'Get',
          typeName: 'StatusData',
          params: `{"search": {"diagnosticSearch": {"id": "DiagnosticOdometerId"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 10}`
        },
        'devices-in-group': {
          method: 'Get',
          typeName: 'Device',
          params: '{"search": {"groups": [{"id": "GroupCompanyId"}]}, "resultsLimit": 10}'
        },
        'gps-data': {
          method: 'Get',
          typeName: 'LogRecord',
          params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 50}`
        },
        'trips': {
          method: 'Get',
          typeName: 'Trip',
          params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 10}`
        },
        'stops': {
          method: 'Get',
          typeName: 'Stop',
          params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
        },
        'zones': {
          method: 'Get',
          typeName: 'Zone',
          params: '{"resultsLimit": 20}'
        },
        'fuel-data': {
          method: 'Get',
          typeName: 'StatusData',
          params: `{"search": {"diagnosticSearch": {"id": "DiagnosticFuelLevelId"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
        },
        'engine-data': {
          method: 'Get',
          typeName: 'StatusData',
          params: `{"search": {"diagnosticSearch": {"id": "DiagnosticIgnitionId"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 20}`
        },
        'fault-data': {
          method: 'Get',
          typeName: 'FaultData',
          params: `{"search": {"fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 10}`
        },
        'diagnostics': {
          method: 'Get',
          typeName: 'Diagnostic',
          params: '{"resultsLimit": 50}'
        },
        'multi-odometer': {
          method: 'ExecuteMultiCall',
          typeName: '',
          params: `{"calls": [{"method": "Get", "params": {"typeName": "StatusData", "search": {"diagnosticSearch": {"id": "DiagnosticOdometerId"}, "fromDate": "${yesterday}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 5}}]}`
        },
        'fleet-summary': {
          method: 'ExecuteMultiCall',
          typeName: '',
          params: `{"calls": [{"method": "Get", "params": {"typeName": "Device", "resultsLimit": 10}}, {"method": "Get", "params": {"typeName": "Trip", "search": {"fromDate": "${today}T00:00:00.000Z", "toDate": "${today}T23:59:59.000Z"}, "resultsLimit": 10}}]}`
        },
        'users': {
          method: 'Get',
          typeName: 'User',
          params: '{"search": {"name": "%"}, "resultsLimit": 10}'
        },
        'groups': {
          method: 'Get',
          typeName: 'Group',
          params: '{"search": {"name": "%"}, "resultsLimit": 10}'
        }
      };
      
      const example = examples[type];
      if (example) {
        document.getElementById('method').value = example.method;
        document.getElementById('typeName').value = example.typeName;
        document.getElementById('params').value = example.params;
        
        document.getElementById('apiSection').scrollIntoView({ behavior: 'smooth' });
      }
    }

    // CSV Download (simplified)
    document.getElementById('downloadCsv').onclick = function() {
      if (!lastApiResult) {
        showMessage('apiResult', '‚ö†Ô∏è No data available for download', 'warning');
        return;
      }
      
      const csvContent = JSON.stringify(lastApiResult.data, null, 2);
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `geotab_${lastApiResult.method}_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showMessage('apiResult', '‚úÖ Data downloaded!', 'success');
    };

    // Logout
    document.getElementById('logout').onclick = function() {
      credentials = null;
      serverUsed = null;
      lastApiResult = null;
      document.getElementById('apiSection').style.display = 'none';
      document.getElementById('authResult').innerHTML = '';
      document.getElementById('apiResult').innerHTML = '';
      
      const authBtn = document.getElementById('authButton');
      authBtn.innerHTML = '<span class="status-indicator status-disconnected"></span>Authenticate';
      
      // Clear form
      document.getElementById('server').value = '';
      document.getElementById('database').value = '';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    };

    // Initialize when page loads
    window.addEventListener('load', initializeGeotabAddin);
  </script>
</body>
</html>
