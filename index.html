<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RUC Management - Bare Minimum</title>
    <script src="https://cdn.jsdelivr.net/npm/mg-api-js@2.0.1"></script>
</head>
<body>
    <h1>RUC License Management</h1>
    
    <h2>CSV Import</h2>
    <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
    <button onclick="triggerCsvImport()" style="background: green; color: white; padding: 20px; font-size: 18px; margin: 10px; border: none; cursor: pointer;">IMPORT CSV FILE</button>
    <button onclick="downloadCsvTemplate()" style="background: blue; color: white; padding: 20px; font-size: 18px; margin: 10px; border: none; cursor: pointer;">DOWNLOAD TEMPLATE</button>
    <p id="csv-status" style="font-weight: bold; color: green;"></p>
    
    <div id="csv-preview" style="display: none; background: #f0f0f0; padding: 15px; margin: 10px; border: 1px solid #ccc;">
        <h3>Preview:</h3>
        <div id="csv-preview-content"></div>
        <button onclick="confirmCsvImport()" style="background: green; color: white; padding: 10px; margin: 5px; border: none; cursor: pointer;">CONFIRM IMPORT</button>
        <button onclick="cancelCsvImport()" style="background: gray; color: white; padding: 10px; margin: 5px; border: none; cursor: pointer;">CANCEL</button>
    </div>
    
    <h2>Fleet Data</h2>
    <button onclick="refreshOdometerData()" style="background: orange; color: white; padding: 20px; font-size: 18px; margin: 10px; border: none; cursor: pointer;">REFRESH ODOMETER</button>
    
    <div id="stats" style="margin: 20px;">
        <p>Total Vehicles: <span id="total-count">0</span></p>
        <p>Active: <span id="active-count">0</span></p>
        <p>Expiring: <span id="expiring-count">0</span></p>
        <p>Expired: <span id="expired-count">0</span></p>
    </div>
    
    <div id="vehicle-list" style="margin: 20px;"></div>
    
    <script>
        let geotabApi = null;
        let vehicles = [];
        let csvImportData = null;

        // MyGeotab Add-In registration
        if (typeof geotab !== 'undefined') {
            geotab.addin.rucManagement = function(api, state) {
                geotabApi = api;
                return {
                    initialize: function(freshApi, freshState, callback) {
                        console.log('RUC Management Add-In initializing...');
                        geotabApi = freshApi;
                        setupCsvImport();
                        loadMockData();
                        callback();
                    },
                    focus: function(freshApi, freshState) {
                        geotabApi = freshApi;
                    },
                    blur: function() {}
                };
            };
        } else {
            // Load mock data for testing outside MyGeotab
            window.addEventListener('load', function() {
                setupCsvImport();
                loadMockData();
            });
        }

        function setupCsvImport() {
            console.log('Setting up CSV import...');
            const fileInput = document.getElementById('csv-file-input');
            if (fileInput) {
                fileInput.addEventListener('change', handleCsvFile);
                console.log('CSV file input listener added');
            } else {
                console.error('CSV file input not found!');
            }
        }

        function triggerCsvImport() {
            console.log('CSV import button clicked!');
            document.getElementById('csv-status').textContent = 'Opening file picker...';
            document.getElementById('csv-file-input').click();
        }

        function downloadCsvTemplate() {
            console.log('Download template button clicked!');
            const template = `plate,make,model,year,odometer,license_end_odometer
TEST-001,Toyota,Hilux,2023,45000,47500
TEST-002,Ford,Ranger,2022,78000,78800
TEST-003,Mitsubishi,Triton,2021,65000,64500`;
            
            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ruc_vehicle_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            document.getElementById('csv-status').textContent = 'Template downloaded successfully!';
        }

        function handleCsvFile(event) {
            console.log('CSV file selected');
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('csv-status').textContent = 'Reading file: ' + file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const parsedData = parseCsvData(csv);
                    
                    if (parsedData.length === 0) {
                        document.getElementById('csv-status').textContent = 'Error: CSV file is empty';
                        return;
                    }
                    
                    csvImportData = parsedData;
                    showCsvPreview(parsedData);
                    document.getElementById('csv-status').textContent = `Found ${parsedData.length} vehicles in CSV file`;
                    
                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    document.getElementById('csv-status').textContent = 'Error: ' + error.message;
                }
            };
            
            reader.readAsText(file);
        }

        function parseCsvData(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                throw new Error('CSV must have header row and at least one data row');
            }
            
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const requiredColumns = ['plate', 'make', 'model', 'year', 'odometer', 'license_end_odometer'];
            const missingColumns = requiredColumns.filter(col => !headers.includes(col));
            
            if (missingColumns.length > 0) {
                throw new Error('Missing columns: ' + missingColumns.join(', '));
            }
            
            const vehicles = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length !== headers.length) continue;
                
                const vehicle = {};
                headers.forEach((header, index) => {
                    vehicle[header] = values[index];
                });
                
                const currentOdometer = parseInt(vehicle.odometer);
                const licenseEndOdometer = parseInt(vehicle.license_end_odometer);
                const year = parseInt(vehicle.year);
                
                if (isNaN(currentOdometer) || isNaN(licenseEndOdometer) || isNaN(year)) continue;
                
                const remainingDistance = licenseEndOdometer - currentOdometer;
                let status = 'active';
                if (remainingDistance <= 0) {
                    status = 'expired';
                } else if (remainingDistance <= 2000) {
                    status = 'expiring';
                }
                
                vehicles.push({
                    id: 'csv-' + i,
                    plateNumber: vehicle.plate,
                    make: vehicle.make,
                    model: vehicle.model,
                    year: year,
                    currentOdometer: currentOdometer,
                    licenseEndOdometer: licenseEndOdometer,
                    remainingDistance: remainingDistance,
                    status: status
                });
            }
            
            return vehicles;
        }

        function showCsvPreview(data) {
            let html = `<p><strong>${data.length} vehicles found</strong></p>`;
            
            data.slice(0, 3).forEach(vehicle => {
                const color = vehicle.status === 'active' ? 'green' : vehicle.status === 'expiring' ? 'orange' : 'red';
                html += `<div style="padding: 5px; border-bottom: 1px solid #ccc;">
                    ${vehicle.plateNumber} - ${vehicle.make} ${vehicle.model} 
                    <span style="color: ${color}; font-weight: bold;">${vehicle.remainingDistance.toLocaleString()} km</span>
                </div>`;
            });
            
            if (data.length > 3) {
                html += `<div style="padding: 5px; color: #666;">... and ${data.length - 3} more vehicles</div>`;
            }
            
            document.getElementById('csv-preview-content').innerHTML = html;
            document.getElementById('csv-preview').style.display = 'block';
        }

        function confirmCsvImport() {
            if (!csvImportData || csvImportData.length === 0) {
                document.getElementById('csv-status').textContent = 'Error: No data to import';
                return;
            }
            
            vehicles = csvImportData;
            updateStats();
            displayVehicles();
            cancelCsvImport();
            document.getElementById('csv-status').textContent = `Successfully imported ${vehicles.length} vehicles!`;
        }

        function cancelCsvImport() {
            document.getElementById('csv-preview').style.display = 'none';
            document.getElementById('csv-file-input').value = '';
            csvImportData = null;
        }

        function refreshOdometerData() {
            console.log('Refresh button clicked!');
            document.getElementById('csv-status').textContent = 'Refreshing odometer data...';
            
            // Simulate refresh
            vehicles = vehicles.map(vehicle => {
                const odometerChange = Math.floor(Math.random() * 50) + 10;
                const newOdometer = vehicle.currentOdometer + odometerChange;
                const remainingDistance = vehicle.licenseEndOdometer - newOdometer;
                
                let status = 'active';
                if (remainingDistance <= 0) {
                    status = 'expired';
                } else if (remainingDistance <= 2000) {
                    status = 'expiring';
                }
                
                return {
                    ...vehicle,
                    currentOdometer: newOdometer,
                    remainingDistance: remainingDistance,
                    status: status
                };
            });
            
            updateStats();
            displayVehicles();
            document.getElementById('csv-status').textContent = 'Odometer data refreshed at ' + new Date().toLocaleTimeString();
        }

        function updateStats() {
            const total = vehicles.length;
            const active = vehicles.filter(v => v.status === 'active').length;
            const expiring = vehicles.filter(v => v.status === 'expiring').length;
            const expired = vehicles.filter(v => v.status === 'expired').length;
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('active-count').textContent = active;
            document.getElementById('expiring-count').textContent = expiring;
            document.getElementById('expired-count').textContent = expired;
        }

        function displayVehicles() {
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="background: #f0f0f0;"><th style="padding: 10px; border: 1px solid #ccc;">Vehicle</th><th style="padding: 10px; border: 1px solid #ccc;">Status</th><th style="padding: 10px; border: 1px solid #ccc;">Odometer</th><th style="padding: 10px; border: 1px solid #ccc;">Remaining</th></tr>';
            
            vehicles.forEach(vehicle => {
                const statusColor = vehicle.status === 'active' ? 'green' : vehicle.status === 'expiring' ? 'orange' : 'red';
                html += `<tr>
                    <td style="padding: 10px; border: 1px solid #ccc;">${vehicle.plateNumber} - ${vehicle.make} ${vehicle.model}</td>
                    <td style="padding: 10px; border: 1px solid #ccc; color: ${statusColor}; font-weight: bold;">${vehicle.status.toUpperCase()}</td>
                    <td style="padding: 10px; border: 1px solid #ccc;">${vehicle.currentOdometer.toLocaleString()} km</td>
                    <td style="padding: 10px; border: 1px solid #ccc; color: ${statusColor}; font-weight: bold;">${vehicle.remainingDistance.toLocaleString()} km</td>
                </tr>`;
            });
            
            html += '</table>';
            document.getElementById('vehicle-list').innerHTML = html;
        }

        function loadMockData() {
            vehicles = [
                {
                    id: 'mock-1',
                    plateNumber: 'TEST-001',
                    make: 'Toyota',
                    model: 'Hilux',
                    year: 2023,
                    currentOdometer: 45000,
                    licenseEndOdometer: 47500,
                    remainingDistance: 2500,
                    status: 'active'
                },
                {
                    id: 'mock-2',
                    plateNumber: 'TEST-002',
                    make: 'Ford',
                    model: 'Ranger',
                    year: 2022,
                    currentOdometer: 78000,
                    licenseEndOdometer: 78800,
                    remainingDistance: 800,
                    status: 'expiring'
                }
            ];
            
            updateStats();
            displayVehicles();
        }
    </script>
</body>
</html>
