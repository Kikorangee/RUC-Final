<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RUC License Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2rem;
            color: #333;
            margin: 0 0 10px 0;
        }
        .header p {
            color: #666;
            margin: 0;
        }
        .panel {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .import-panel {
            background: #f0f9f0;
            border-color: #c3e6c3;
        }
        .import-panel h3 {
            color: #2d5a2d;
            margin: 0 0 10px 0;
        }
        .import-panel p {
            color: #4a744a;
            margin: 0 0 15px 0;
        }
        .button-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        .refresh-btn {
            background: #2196F3;
        }
        .refresh-btn:hover {
            background: #1976D2;
        }
        .cancel-btn {
            background: #666;
        }
        .cancel-btn:hover {
            background: #555;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }
        .stat-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stat-card.active {
            border: 2px solid #2196F3;
        }
        .stat-card.green {
            background: #f0f9f0;
        }
        .stat-card.orange {
            background: #fff7e6;
        }
        .stat-card.red {
            background: #ffebee;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .vehicle-icon {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #e0e0e0;
            border-radius: 4px;
            text-align: center;
            line-height: 30px;
            margin-right: 10px;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .status-expiring {
            background: #fff3e0;
            color: #f57c00;
        }
        .status-expired {
            background: #ffebee;
            color: #d32f2f;
        }
        .preview-box {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
        }
        .preview-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .preview-item:last-child {
            border-bottom: none;
        }
        .hidden {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #ffebee;
            border: 1px solid #f8bbd9;
            border-radius: 4px;
            padding: 15px;
            margin: 20px 0;
            color: #d32f2f;
        }
        .success {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            z-index: 1000;
        }
        .warning {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #FF9800;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            z-index: 1000;
        }
        .csv-status {
            color: #4a744a;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>RUC License Management</h1>
            <p>Monitor your fleet's Road User Charges license status with 2000km alert threshold</p>
        </div>
        
        <div id="stats-cards" class="stats-grid"></div>

        <!-- CSV Import Panel -->
        <div class="panel import-panel">
            <h3>Import Vehicle Data</h3>
            <p>Import your RUC license data from a CSV file</p>
            <div class="button-row">
                <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
                <button onclick="triggerCsvImport()">Import CSV File</button>
                <button onclick="downloadCsvTemplate()">Download Template</button>
                <span id="csv-status" class="csv-status"></span>
            </div>
            <div id="csv-preview" class="hidden">
                <h4>Import Preview:</h4>
                <div id="csv-preview-content"></div>
                <div style="margin-top: 15px;">
                    <button onclick="confirmCsvImport()">Confirm Import</button>
                    <button onclick="cancelCsvImport()" class="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h3 style="margin: 0;">Fleet License Status</h3>
                    <p id="filter-info" style="margin: 5px 0 0 0; color: #666; font-size: 14px;" class="hidden"></p>
                </div>
                <button id="refresh-btn" onclick="refreshOdometerData()" class="refresh-btn">
                    <span id="refresh-icon">🔄</span>
                    <span id="refresh-text">Refresh Odometer</span>
                </button>
            </div>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Vehicle</th>
                            <th>License Status</th>
                            <th>Current Odometer</th>
                            <th>Remaining Distance</th>
                        </tr>
                    </thead>
                    <tbody id="vehicle-table-body">
                    </tbody>
                </table>
                
                <div id="loading-state" class="loading">
                    <p>Loading vehicle data from MyGeotab...</p>
                </div>
                
                <div id="error-state" class="error hidden">
                    <h4>API Error</h4>
                    <p id="error-message"></p>
                    <button onclick="retryLoadData()">Retry</button>
                </div>
                
                <div id="empty-state" class="loading hidden">
                    <p>No vehicles found</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let geotabApi = null;
        let currentState = null;
        let vehicles = [];
        let filteredVehicles = [];
        let statusFilter = null;
        let csvImportData = null;

        // Initialize
        window.addEventListener('load', function() {
            console.log('RUC Dashboard loaded');
            setupCsvImport();
            loadMockData(); // Load some data to test buttons
        });

        // MyGeotab Add-In registration
        if (typeof geotab !== 'undefined') {
            geotab.addin.rucManagement = function(api, state) {
                geotabApi = api;
                currentState = state;
                
                return {
                    initialize: function(freshApi, freshState, callback) {
                        console.log('RUC Management Add-In initializing...');
                        geotabApi = freshApi;
                        currentState = freshState;
                        
                        setupCsvImport();
                        loadVehicleData().then(() => {
                            callback();
                        }).catch(error => {
                            console.error('Failed to load initial data:', error);
                            callback();
                        });
                    },
                    
                    focus: function(freshApi, freshState) {
                        geotabApi = freshApi;
                        currentState = freshState;
                        loadVehicleData();
                    },
                    
                    blur: function() {
                        console.log('RUC Management Add-In blur');
                    }
                };
            };
        }

        function setupCsvImport() {
            const fileInput = document.getElementById('csv-file-input');
            if (fileInput) {
                fileInput.addEventListener('change', handleCsvFile);
                console.log('CSV import setup complete');
            } else {
                console.error('CSV file input not found');
            }
        }

        function triggerCsvImport() {
            console.log('CSV import button clicked');
            const fileInput = document.getElementById('csv-file-input');
            if (fileInput) {
                fileInput.click();
            } else {
                console.error('CSV file input not found');
            }
        }

        function downloadCsvTemplate() {
            console.log('Download template button clicked');
            const template = `plate,make,model,year,odometer,license_end_odometer
TEST-001,Toyota,Hilux,2023,45000,47500
TEST-002,Ford,Ranger,2022,78000,78800
TEST-003,Mitsubishi,Triton,2021,65000,64500`;
            
            const blob = new Blob([template], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ruc_vehicle_template.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showSuccessMessage('CSV template downloaded');
        }

        function handleCsvFile(event) {
            console.log('CSV file selected');
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('csv-status').textContent = 'Reading file...';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const parsedData = parseCsvData(csv);
                    
                    if (parsedData.length === 0) {
                        showError('CSV file appears to be empty or invalid');
                        return;
                    }
                    
                    csvImportData = parsedData;
                    showCsvPreview(parsedData);
                    document.getElementById('csv-status').textContent = `Found ${parsedData.length} vehicles in CSV`;
                    
                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    showError('Error reading CSV file: ' + error.message);
                    document.getElementById('csv-status').textContent = 'Error reading file';
                }
            };
            
            reader.readAsText(file);
        }

        function parseCsvData(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) {
                throw new Error('CSV must have at least a header row and one data row');
            }
            
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const requiredColumns = ['plate', 'make', 'model', 'year', 'odometer', 'license_end_odometer'];
            const missingColumns = requiredColumns.filter(col => !headers.includes(col));
            
            if (missingColumns.length > 0) {
                throw new Error(`Missing required columns: ${missingColumns.join(', ')}`);
            }
            
            const vehicles = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                
                if (values.length !== headers.length) {
                    continue;
                }
                
                const vehicle = {};
                headers.forEach((header, index) => {
                    vehicle[header] = values[index];
                });
                
                try {
                    const currentOdometer = parseInt(vehicle.odometer);
                    const licenseEndOdometer = parseInt(vehicle.license_end_odometer);
                    const year = parseInt(vehicle.year);
                    
                    if (isNaN(currentOdometer) || isNaN(licenseEndOdometer) || isNaN(year)) {
                        continue;
                    }
                    
                    const remainingDistance = licenseEndOdometer - currentOdometer;
                    let status = 'active';
                    if (remainingDistance <= 0) {
                        status = 'expired';
                    } else if (remainingDistance <= 2000) {
                        status = 'expiring';
                    }
                    
                    vehicles.push({
                        id: 'csv-' + i,
                        plateNumber: vehicle.plate || 'Unknown',
                        make: vehicle.make || 'Unknown',
                        model: vehicle.model || 'Unknown',
                        year: year,
                        currentOdometer: currentOdometer,
                        licenseEndOdometer: licenseEndOdometer,
                        remainingDistance: remainingDistance,
                        status: status,
                        source: 'csv-import'
                    });
                    
                } catch (error) {
                    console.warn(`Error processing row ${i + 1}:`, error.message);
                }
            }
            
            return vehicles;
        }

        function showCsvPreview(data) {
            const preview = data.slice(0, 3);
            const previewHtml = `
                <p><strong>${data.length} vehicles found</strong></p>
                <div class="preview-box">
                    ${preview.map(vehicle => `
                        <div class="preview-item">
                            <span>${vehicle.plateNumber} - ${vehicle.make} ${vehicle.model}</span>
                            <span style="color: ${vehicle.status === 'active' ? 'green' : vehicle.status === 'expiring' ? 'orange' : 'red'}">
                                ${vehicle.remainingDistance.toLocaleString()} km
                            </span>
                        </div>
                    `).join('')}
                    ${data.length > 3 ? `<div style="padding: 5px 0; color: #666;">... and ${data.length - 3} more vehicles</div>` : ''}
                </div>
            `;
            
            document.getElementById('csv-preview-content').innerHTML = previewHtml;
            document.getElementById('csv-preview').classList.remove('hidden');
        }

        function confirmCsvImport() {
            if (!csvImportData || csvImportData.length === 0) {
                showError('No CSV data to import');
                return;
            }
            
            vehicles = csvImportData;
            updateStatsCards();
            filterAndDisplayVehicles();
            
            cancelCsvImport();
            showSuccessMessage(`Successfully imported ${vehicles.length} vehicles from CSV`);
        }

        function cancelCsvImport() {
            document.getElementById('csv-preview').classList.add('hidden');
            document.getElementById('csv-status').textContent = '';
            document.getElementById('csv-file-input').value = '';
            csvImportData = null;
        }

        function loadMockData() {
            console.log('Loading mock data for testing...');
            
            vehicles = [
                {
                    id: 'mock-1',
                    plateNumber: 'TEST-001',
                    make: 'Toyota',
                    model: 'Hilux',
                    year: 2023,
                    currentOdometer: 45000,
                    licenseEndOdometer: 47500,
                    remainingDistance: 2500,
                    status: 'active'
                },
                {
                    id: 'mock-2',
                    plateNumber: 'TEST-002',
                    make: 'Ford',
                    model: 'Ranger',
                    year: 2022,
                    currentOdometer: 78000,
                    licenseEndOdometer: 78800,
                    remainingDistance: 800,
                    status: 'expiring'
                },
                {
                    id: 'mock-3',
                    plateNumber: 'TEST-003',
                    make: 'Mitsubishi',
                    model: 'Triton',
                    year: 2021,
                    currentOdometer: 65000,
                    licenseEndOdometer: 64500,
                    remainingDistance: -500,
                    status: 'expired'
                }
            ];
            
            updateStatsCards();
            filterAndDisplayVehicles();
            showLoading(false);
        }

        async function loadVehicleData() {
            if (!geotabApi) {
                loadMockData();
                return;
            }
            
            try {
                showLoading(true);
                hideError();
                
                const devices = await geotabApi.call('Get', {
                    typeName: 'Device'
                });
                
                if (!devices || devices.length === 0) {
                    showError('No vehicles found in your MyGeotab account');
                    return;
                }
                
                vehicles = transformMyGeotabData(devices);
                updateStatsCards();
                filterAndDisplayVehicles();
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading vehicle data:', error);
                showError('Failed to load vehicle data: ' + error.message);
                showLoading(false);
            }
        }

        function refreshOdometerData() {
            console.log('Refresh button clicked!');
            setRefreshState(true);
            
            setTimeout(() => {
                // Simulate refresh for testing
                vehicles = vehicles.map(vehicle => {
                    const odometerChange = Math.floor(Math.random() * 50) + 10;
                    const newOdometer = vehicle.currentOdometer + odometerChange;
                    const remainingDistance = vehicle.licenseEndOdometer - newOdometer;
                    
                    let status = 'active';
                    if (remainingDistance <= 0) {
                        status = 'expired';
                    } else if (remainingDistance <= 2000) {
                        status = 'expiring';
                    }
                    
                    return {
                        ...vehicle,
                        currentOdometer: newOdometer,
                        remainingDistance: remainingDistance,
                        status: status,
                        lastUpdated: new Date().toLocaleTimeString()
                    };
                });
                
                updateStatsCards();
                filterAndDisplayVehicles();
                setRefreshState(false);
                showSuccessMessage('Odometer data refreshed');
            }, 1500);
        }

        function transformMyGeotabData(devices) {
            return devices.map(device => {
                const latestOdometer = Math.floor(Math.random() * 200000) + 50000;
                const mockLicenseEndOdometer = latestOdometer + Math.floor(Math.random() * 5000) + 1000;
                const remainingDistance = mockLicenseEndOdometer - latestOdometer;
                
                let status = 'active';
                if (remainingDistance <= 0) {
                    status = 'expired';
                } else if (remainingDistance <= 2000) {
                    status = 'expiring';
                }
                
                return {
                    id: device.id,
                    plateNumber: device.name || 'Unknown',
                    make: 'Fleet Vehicle',
                    model: device.comment || 'Model Unknown',
                    year: new Date().getFullYear(),
                    currentOdometer: latestOdometer,
                    licenseEndOdometer: mockLicenseEndOdometer,
                    remainingDistance: remainingDistance,
                    status: status
                };
            });
        }

        function setStatusFilter(status) {
            statusFilter = status;
            updateStatsCards();
            filterAndDisplayVehicles();
        }

        function updateStatsCards() {
            const stats = {
                totalVehicles: vehicles.length,
                activeLicenses: vehicles.filter(v => v.status === 'active').length,
                expiringSoon: vehicles.filter(v => v.status === 'expiring').length,
                expired: vehicles.filter(v => v.status === 'expired').length
            };
            
            const statsHtml = `
                <div class="stat-card ${statusFilter === null ? 'active' : ''}" onclick="setStatusFilter(null)">
                    <h2>🚛 Total Vehicles ${stats.totalVehicles}</h2>
                </div>
                <div class="stat-card green ${statusFilter === 'active' ? 'active' : ''}" onclick="setStatusFilter('active')">
                    <h2>✅ Active Licenses ${stats.activeLicenses}</h2>
                </div>
                <div class="stat-card orange ${statusFilter === 'expiring' ? 'active' : ''}" onclick="setStatusFilter('expiring')">
                    <h2>⚠️ Expiring (≤2000km) ${stats.expiringSoon}</h2>
                </div>
                <div class="stat-card red ${statusFilter === 'expired' ? 'active' : ''}" onclick="setStatusFilter('expired')">
                    <h2>❌ Expired ${stats.expired}</h2>
                </div>
            `;
            
            document.getElementById('stats-cards').innerHTML = statsHtml;
        }

        function filterAndDisplayVehicles() {
            filteredVehicles = vehicles.filter(vehicle => {
                return statusFilter === null || vehicle.status === statusFilter;
            });
            
            updateFilterInfo();
            displayVehicles();
        }

        function updateFilterInfo() {
            const filterInfo = document.getElementById('filter-info');
            
            if (statusFilter) {
                const statusName = statusFilter === 'expiring' ? 'expiring soon' : statusFilter;
                filterInfo.textContent = `Showing ${filteredVehicles.length} of ${vehicles.length} vehicles (status: ${statusName})`;
                filterInfo.classList.remove('hidden');
            } else {
                filterInfo.classList.add('hidden');
            }
        }

        function displayVehicles() {
            const tbody = document.getElementById('vehicle-table-body');
            
            if (filteredVehicles.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                tbody.innerHTML = '';
                return;
            }
            
            document.getElementById('empty-state').classList.add('hidden');
            
            const vehicleRows = filteredVehicles.map(vehicle => {
                const statusBadge = getStatusBadge(vehicle.status);
                const formattedDistance = formatDistance(vehicle.remainingDistance);
                
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center;">
                                <div class="vehicle-icon">🚛</div>
                                <div>
                                    <div style="font-weight: bold;">${vehicle.plateNumber}</div>
                                    <div style="color: #666; font-size: 12px;">${vehicle.make} ${vehicle.model} ${vehicle.year}</div>
                                </div>
                            </div>
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            <div>${vehicle.currentOdometer.toLocaleString()} km</div>
                            ${vehicle.lastUpdated ? `<div style="color: #666; font-size: 11px;">Updated: ${vehicle.lastUpdated}</div>` : ''}
                        </td>
                        <td>
                            <span style="font-weight: bold; color: ${getDistanceColor(vehicle.status)}">
                                ${formattedDistance}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = vehicleRows;
        }

        function getStatusBadge(status) {
            const badges = {
                active: '<span class="status-badge status-active">✅ Active</span>',
                expiring: '<span class="status-badge status-expiring">⚠️ Expiring Soon</span>',
                expired: '<span class="status-badge status-expired">❌ Expired</span>'
            };
            return badges[status] || '';
        }

        function getDistanceColor(status) {
            const colors = {
                active: '#2e7d32',
                expiring: '#f57c00',
                expired: '#d32f2f'
            };
            return colors[status] || '#333';
        }

        function formatDistance(distance) {
            if (distance < 0) {
                return `-${Math.abs(distance).toLocaleString()} km`;
            }
            return `${distance.toLocaleString()} km`;
        }

        function setRefreshState(isRefreshing) {
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshIcon = document.getElementById('refresh-icon');
            const refreshText = document.getElementById('refresh-text');
            
            if (isRefreshing) {
                refreshBtn.disabled = true;
                refreshIcon.innerHTML = '⏳';
                refreshText.textContent = 'Refreshing...';
            } else {
                refreshBtn.disabled = false;
                refreshIcon.innerHTML = '🔄';
                refreshText.textContent = 'Refresh Odometer';
            }
        }

        function retryLoadData() {
            loadVehicleData();
        }

        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-state').classList.remove('hidden');
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('empty-state').classList.add('hidden');
        }

        function hideError() {
            document.getElementById('error-state').classList.add('hidden');
        }

        function showSuccessMessage(message) {
            const notification = document.createElement('div');
            notification.className = 'success';
            notification.textContent = '✓ ' + message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }

        function showLoading(show) {
            document.getElementById('loading-state').style.display = show ? 'block' : 'none';
            document.getElementById('vehicle-table-body').style.display = show ? 'none' : 'table-row-group';
            
            if (show) {
                hideError();
                document.getElementById('empty-state').classList.add('hidden');
            }
        }
    </script>
</body>
</html>
