<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>RUC License Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/mg-api-js@2.0.1"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="ruc-management-app" class="p-6 max-w-7xl mx-auto">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">RUC License Management</h1>
            <p class="text-gray-600 mt-2">Monitor your fleet's Road User Charges license status with 2000km alert threshold</p>
        </div>
        
        <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"></div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Fleet License Status</h3>
                    <p id="filter-info" class="text-sm text-gray-600 mt-1 hidden"></p>
                </div>
                <button id="refresh-btn" onclick="refreshOdometerData()" class="inline-flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
                    <span id="refresh-icon" class="mr-2">üîÑ</span>
                    <span id="refresh-text">Refresh Odometer</span>
                </button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehicle</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">License Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Odometer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining Distance</th>
                        </tr>
                    </thead>
                    <tbody id="vehicle-table-body" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
                
                <div id="loading-state" class="text-center py-12">
                    <p class="text-gray-500">‚è≥ Loading vehicle data from MyGeotab...</p>
                </div>
                
                <div id="empty-state" class="text-center py-12 hidden">
                    <p class="text-gray-500">üöõ No vehicles found</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let geotabApi = null;
        let currentState = null;
        let vehicles = [];
        let filteredVehicles = [];
        let statusFilter = null;

        geotab.addin.rucManagement = function(api, state) {
            geotabApi = api;
            currentState = state;
            
            return {
                initialize: function(freshApi, freshState, callback) {
                    console.log('RUC Management Add-In initializing...');
                    geotabApi = freshApi;
                    currentState = freshState;
                    
                    loadVehicleData().then(() => {
                        callback();
                    }).catch(error => {
                        console.error('Failed to load initial data:', error);
                        callback();
                    });
                },
                
                focus: function(freshApi, freshState) {
                    geotabApi = freshApi;
                    currentState = freshState;
                    loadVehicleData();
                },
                
                blur: function() {
                    console.log('RUC Management Add-In blur');
                }
            };
        };

        async function loadVehicleData() {
            try {
                showLoading(true);
                
                const devices = await geotabApi.call('Get', {
                    typeName: 'Device'
                });
                
                vehicles = transformMyGeotabData(devices);
                
                updateStatsCards();
                filterAndDisplayVehicles();
                
                showLoading(false);
                
            } catch (error) {
                console.error('Error loading vehicle data:', error);
                showLoading(false);
            }
        }

        async function refreshOdometerData() {
            try {
                setRefreshState(true);
                console.log('Refreshing odometer data...');
                
                // Get fresh device data
                const devices = await geotabApi.call('Get', {
                    typeName: 'Device',
                    resultsLimit: 50
                });
                
                await fetchLiveOdometerData(devices);
                
                updateStatsCards();
                filterAndDisplayVehicles();
                
                setRefreshState(false);
                
            } catch (error) {
                console.error('Error refreshing odometer data:', error);
                setRefreshState(false);
            }
        }

        async function fetchLiveOdometerData(devices) {
            return new Promise((resolve, reject) => {
                const group = {
                    id: "GroupCompanyId" // Will use all devices if no specific group
                };
                const results = [];
                const now = new Date().toISOString();
                const calls = [];
                const diagnostic = {
                    id: "DiagnosticOdometerAdjustmentId"
                };

                devices.forEach(function (device) {
                    results.push({
                        id: device.id,
                        name: device.name,
                        vehicleIdentificationNumber: device.vehicleIdentificationNumber,
                        device: device
                    });
                    calls.push({
                        method: "Get",
                        params: {
                            typeName: "StatusData",
                            search: {
                                fromDate: now,
                                toDate: now,
                                diagnosticSearch: diagnostic,
                                deviceSearch: { id: device.id }
                            }
                        }
                    });
                });

                geotabApi.call("ExecuteMultiCall", {
                    calls: calls
                }, function (callResults) {
                    try {
                        let statusData, i;
                        for (i = 0; i < callResults.length; i++) {
                            statusData = callResults[i][0];
                            if (statusData) {
                                results[i].odometer = statusData.data;
                            }
                        }
                        
                        // Update vehicles array with live odometer data
                        vehicles = vehicles.map(vehicle => {
                            const liveData = results.find(r => r.id === vehicle.id);
                            if (liveData && liveData.odometer) {
                                const newOdometer = Math.round(liveData.odometer);
                                const remainingDistance = vehicle.licenseEndOdometer - newOdometer;
                                
                                let status = 'active';
                                if (remainingDistance <= 0) {
                                    status = 'expired';
                                } else if (remainingDistance <= 2000) {
                                    status = 'expiring';
                                }
                                
                                return {
                                    ...vehicle,
                                    currentOdometer: newOdometer,
                                    remainingDistance: remainingDistance,
                                    status: status,
                                    lastUpdated: new Date().toLocaleTimeString()
                                };
                            }
                            return vehicle;
                        });
                        
                        console.log('Updated vehicles with live odometer data:', vehicles);
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        }

        function transformMyGeotabData(devices) {
            return devices.map(device => {
                const latestOdometer = Math.floor(Math.random() * 200000) + 50000;
                const mockLicenseEndOdometer = latestOdometer + Math.floor(Math.random() * 5000) + 1000;
                const remainingDistance = mockLicenseEndOdometer - latestOdometer;
                
                let status = 'active';
                if (remainingDistance <= 0) {
                    status = 'expired';
                } else if (remainingDistance <= 2000) {
                    status = 'expiring';
                }
                
                return {
                    id: device.id,
                    plateNumber: device.name || 'Unknown',
                    make: device.vehicleIdentificationNumber ? 'Fleet Vehicle' : 'Unknown',
                    model: device.comment || 'Model Unknown',
                    year: new Date().getFullYear(),
                    currentOdometer: latestOdometer,
                    licenseEndOdometer: mockLicenseEndOdometer,
                    remainingDistance: remainingDistance,
                    status: status
                };
            });
        }

        function setStatusFilter(status) {
            statusFilter = status;
            updateStatsCards();
            filterAndDisplayVehicles();
        }

        function updateStatsCards() {
            const stats = {
                totalVehicles: vehicles.length,
                activeLicenses: vehicles.filter(v => v.status === 'active').length,
                expiringSoon: vehicles.filter(v => v.status === 'expiring').length,
                expired: vehicles.filter(v => v.status === 'expired').length
            };
            
            const statsHtml = `
                <div class="p-6 bg-white rounded-lg shadow cursor-pointer transition-all hover:shadow-md ${statusFilter === null ? 'border-2 border-blue-500' : ''}" onclick="setStatusFilter(null)">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="mr-2">üöõ</span> Total Vehicles ${stats.totalVehicles}
                    </h2>
                </div>
                <div class="p-6 bg-green-50 rounded-lg shadow cursor-pointer transition-all hover:shadow-md ${statusFilter === 'active' ? 'border-2 border-blue-500' : ''}" onclick="setStatusFilter('active')">
                    <h2 class="text-lg font-semibold mb-4 flex items-center text-green-800">
                        <span class="mr-2">‚úÖ</span> Active Licenses ${stats.activeLicenses}
                    </h2>
                </div>
                <div class="p-6 bg-orange-50 rounded-lg shadow cursor-pointer transition-all hover:shadow-md ${statusFilter === 'expiring' ? 'border-2 border-blue-500' : ''}" onclick="setStatusFilter('expiring')">
                    <h2 class="text-lg font-semibold mb-4 flex items-center text-orange-800">
                        <span class="mr-2">‚ö†Ô∏è</span> Expiring (‚â§2000km) ${stats.expiringSoon}
                    </h2>
                </div>
                <div class="p-6 bg-red-50 rounded-lg shadow cursor-pointer transition-all hover:shadow-md ${statusFilter === 'expired' ? 'border-2 border-blue-500' : ''}" onclick="setStatusFilter('expired')">
                    <h2 class="text-lg font-semibold mb-4 flex items-center text-red-800">
                        <span class="mr-2">‚ùå</span> Expired ${stats.expired}
                    </h2>
                </div>
            `;
            
            document.getElementById('stats-cards').innerHTML = statsHtml;
        }

        function filterAndDisplayVehicles() {
            filteredVehicles = vehicles.filter(vehicle => {
                const matchesStatus = statusFilter === null || vehicle.status === statusFilter;
                return matchesStatus;
            });
            
            updateFilterInfo();
            displayVehicles();
        }

        function updateFilterInfo() {
            const filterInfo = document.getElementById('filter-info');
            
            if (statusFilter) {
                const statusName = statusFilter === 'expiring' ? 'expiring soon' : statusFilter;
                filterInfo.textContent = `Showing ${filteredVehicles.length} of ${vehicles.length} vehicles (status: ${statusName})`;
                filterInfo.classList.remove('hidden');
            } else {
                filterInfo.classList.add('hidden');
            }
        }

        function displayVehicles() {
            const tbody = document.getElementById('vehicle-table-body');
            
            if (filteredVehicles.length === 0) {
                document.getElementById('empty-state').classList.remove('hidden');
                tbody.innerHTML = '';
                return;
            }
            
            document.getElementById('empty-state').classList.add('hidden');
            
            const vehicleRows = filteredVehicles.map(vehicle => {
                const statusBadge = getStatusBadge(vehicle.status);
                const formattedDistance = formatDistance(vehicle.remainingDistance);
                
                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center mr-3">
                                    <span class="text-gray-500">üöõ</span>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-900">${vehicle.plateNumber}</div>
                                    <div class="text-sm text-gray-500">${vehicle.make} ${vehicle.model} ${vehicle.year}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${statusBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${vehicle.currentOdometer.toLocaleString()} km</div>
                            ${vehicle.lastUpdated ? `<div class="text-xs text-gray-500">Updated: ${vehicle.lastUpdated}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="text-sm font-medium ${getDistanceColor(vehicle.status)}">
                                ${formattedDistance}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = vehicleRows;
        }

        function getStatusBadge(status) {
            const badges = {
                active: '<span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full">‚úÖ Active</span>',
                expiring: '<span class="inline-flex items-center px-3 py-1 bg-orange-100 text-orange-800 text-xs rounded-full">‚ö†Ô∏è Expiring Soon</span>',
                expired: '<span class="inline-flex items-center px-3 py-1 bg-red-100 text-red-800 text-xs rounded-full">‚ùå Expired</span>'
            };
            return badges[status] || '';
        }

        function getDistanceColor(status) {
            const colors = {
                active: 'text-green-600',
                expiring: 'text-orange-600',
                expired: 'text-red-600'
            };
            return colors[status] || 'text-gray-900';
        }

        function formatDistance(distance) {
            if (distance < 0) {
                return `-${Math.abs(distance).toLocaleString()} km`;
            }
            return `${distance.toLocaleString()} km`;
        }

        function setRefreshState(isRefreshing) {
            const refreshBtn = document.getElementById('refresh-btn');
            const refreshIcon = document.getElementById('refresh-icon');
            const refreshText = document.getElementById('refresh-text');
            
            if (isRefreshing) {
                refreshBtn.disabled = true;
                refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
                refreshIcon.innerHTML = '‚è≥';
                refreshText.textContent = 'Refreshing...';
            } else {
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                refreshIcon.innerHTML = 'üîÑ';
                refreshText.textContent = 'Refresh Odometer';
            }
        }

        function showLoading(show) {
            document.getElementById('loading-state').style.display = show ? 'block' : 'none';
            document.getElementById('vehicle-table-body').style.display = show ? 'none' : 'table-row-group';
        }
    </script>
</body>
</html>
